# Steamji Docker Compose 项目结构说明

## 整体架构设计

### 服务整合方案
将原有的三个独立服务组件整合到统一的Docker Compose编排中：

1. **PostgreSQL数据库服务** - 替代原有的SQLite/外部PostgreSQL
2. **Strapi API服务** - 基于原有server目录构建
3. **ASF挂卡服务** - 使用官方Docker镜像

### 目录结构设计
```
steamji/
├── docker/                          # Docker部署目录（新增）
│   ├── docker-compose.yaml         # 服务编排主文件
│   ├── Dockerfile.strapi           # Strapi自定义镜像构建
│   ├── .env.example                # 环境变量模板
│   ├── config/                     # 配置文件目录
│   │   └── database.js             # Strapi数据库配置
│   ├── init-scripts/               # 初始化脚本
│   │   ├── 01-init-db.sql         # 数据库初始化
│   │   └── 02-asf-config.sh       # ASF配置初始化
│   ├── asf-config/                 # ASF配置文件目录
│   ├── start.sh                   # 一键启动脚本
│   ├── stop.sh                    # 停止服务脚本
│   ├── update.sh                  # 更新服务脚本
│   ├── backup.sh                  # 数据备份脚本
│   └── README.md                  # 部署文档
├── miniapp/                        # 小程序前端（保持不变）
├── server/                         # Strapi后端（保持不变）
└── figma/                         # 设计资源（保持不变）
```

## 核心配置说明

### 1. Docker Compose 编排设计

**服务依赖关系**：
```
PostgreSQL ← Strapi API
      ↓
    ASF服务
```

**网络架构**：
- 使用自定义桥接网络 `steamji_network`
- 服务间通过容器名进行内部通信
- 外部通过映射端口访问

**数据持久化**：
- `postgres_data`: 数据库数据卷
- `strapi_data`: Strapi临时文件卷  
- `strapi_uploads`: 文件上传卷
- `asf_config`: ASF配置卷

### 2. 环境变量集中管理

在 `.env` 文件中统一管理所有配置：

```env
# 数据库配置
POSTGRES_DB=steamji
POSTGRES_USER=steamji
POSTGRES_PASSWORD=your_password

# Strapi配置
STRAPI_PORT=1337
APP_KEYS=your_keys

# ASF配置  
ASF_PORT=2222
ASF_IPC_PASSWORD=your_password
```

### 3. 服务健康检查

每个服务都配置了健康检查：
- **PostgreSQL**: 使用 `pg_isready` 命令
- **Strapi**: 通过HTTP端点检查
- **ASF**: 检查API可用性

## 与原项目的兼容性

### 保持不变的目录
- `miniapp/`: 小程序前端代码完全兼容
- `server/`: Strapi后端代码无需修改
- `figma/`: 设计资源文件保持不变

### 配置迁移
- 将原有的 `.env.example` 配置迁移到统一的 `.env` 文件
- 数据库配置从SQLite迁移到PostgreSQL
- ASF配置通过卷挂载保持持久化

## 一键启动流程

### 初始化步骤
1. 复制环境变量模板：`cp .env.example .env`
2. 编辑配置：设置数据库密码、安全密钥等
3. 运行启动脚本：`./start.sh`

### 自动执行的操作
- 创建必要的目录结构
- 初始化ASF配置文件
- 启动所有Docker服务
- 等待服务健康检查通过

## 优势与改进

### 1. 部署简化
- 从多步骤手动部署变为一键启动
- 环境配置集中管理
- 依赖关系自动处理

### 2. 环境一致性
- 使用Docker确保开发、测试、生产环境一致
- 版本控制明确的镜像标签
- 可重复的构建过程

### 3. 运维便利
- 完整的服务管理脚本
- 健康检查和自动重启
- 数据备份和恢复机制

### 4. 安全性提升
- 非root用户运行服务
- 网络隔离配置
- 敏感信息环境变量管理

## 扩展性考虑

### 未来扩展方向
1. **负载均衡**: 可添加Nginx反向代理
2. **监控告警**: 集成Prometheus + Grafana
3. **日志收集**: 使用ELK栈集中管理日志
4. **CI/CD**: 结合GitHub Actions自动化部署

### 多环境支持
通过不同的Compose文件支持多环境：
- `docker-compose.dev.yaml` - 开发环境
- `docker-compose.prod.yaml` - 生产环境  
- `docker-compose.test.yaml` - 测试环境

## 总结

该Docker Compose方案成功将原有的复杂部署流程简化为统一的一键启动方案，同时保持了与原项目的完全兼容性。通过合理的服务编排、数据持久化设计和运维脚本，为Steamji项目提供了稳定、可扩展的容器化部署方案。