# Steamji Docker 部署验证指南

## 当前状态检查

### ✅ 环境变量配置验证完成
- **数据库配置**：所有参数已正确设置
- **Strapi配置**：端口和安全密钥已配置
- **ASF配置**：IPC密码和端口已设置

### 🔧 配置一致性验证

**数据库连接参数匹配**：
- `POSTGRES_DB=steamji` → `${POSTGRES_DB}` ✅
- `POSTGRES_USER=steamji` → `${POSTGRES_USER}` ✅  
- `POSTGRES_PASSWORD=steamji_passwd0` → `${POSTGRES_PASSWORD}` ✅

**端口映射配置**：
- PostgreSQL容器：`5433:5432`（外部:内部）
- Strapi容器：`1337:1337`
- ASF容器：`2222:1242`

## 🚀 部署前准备

### 1. 安装Docker环境
系统检测到Docker未安装，需要先安装Docker：

**macOS安装**：
```bash
# 使用Homebrew安装
brew install --cask docker

# 或从官网下载Docker Desktop
# https://www.docker.com/products/docker-desktop
```

**验证安装**：
```bash
docker --version
docker compose version
```

### 2. 启动Docker服务
- 打开Docker Desktop应用程序
- 等待Docker守护进程启动

## 📋 部署步骤

### 第一步：验证Docker环境
```bash
# 在项目根目录执行
docker --version
docker compose version
```

### 第二步：构建和启动服务

**方式一：在项目根目录执行（推荐）**
```bash
# 停止现有服务（如果有）
docker compose -f docker/docker-compose.yaml down

# 重新构建镜像
docker compose -f docker/docker-compose.yaml build --no-cache

# 启动所有服务
docker compose -f docker/docker-compose.yaml up -d
```

**方式二：在docker目录执行**
```bash
cd docker

# 停止现有服务（如果有）
docker compose down

# 重新构建镜像
docker compose build --no-cache

# 启动所有服务
docker compose up -d
```

### 第三步：验证服务状态
```bash
# 检查所有容器状态
docker compose ps

# 查看Strapi日志
docker compose logs -f strapi

# 查看PostgreSQL日志  
docker compose logs -f postgres

# 查看ASF日志
docker compose logs -f asf
```

## 🔍 预期结果

### Strapi服务启动成功标志：
- ✅ 连接到 `postgres:5432` 而不是 `127.0.0.1:5432`
- ✅ 不再出现"ECONNREFUSED"错误
- ✅ 显示"Server started"或类似成功消息

### PostgreSQL服务验证：
```bash
# 连接到PostgreSQL验证
docker compose exec postgres psql -U steamji -d steamji -c "SELECT version();"
```

### ASF服务验证：
- 访问 http://localhost:2222 查看ASF控制面板

## ❌ 常见问题解决

### 问题1：Docker命令未找到
**解决方案**：安装Docker Desktop或Docker Engine

### 问题2：端口冲突
**解决方案**：修改.env文件中的端口号
```env
POSTGRES_EXTERNAL_PORT=5434
STRAPI_EXTERNAL_PORT=1338  
ASF_EXTERNAL_PORT=2223
```

### 问题3：权限错误
**解决方案**：确保有足够的权限运行Docker命令

## 📞 技术支持

如果部署过程中遇到问题，请检查：
1. Docker日志输出
2. 容器状态：`docker compose ps`
3. 服务健康检查：`docker compose logs`

当前配置已验证正确，等待Docker环境安装后即可部署。